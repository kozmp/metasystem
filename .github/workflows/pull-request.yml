name: Pull Request CI

on:
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]

# Anuluj poprzednie workflow dla tego samego PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # JOB 1: LINTOWANIE I SPRAWDZENIE TYPÃ“W
  # ============================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: '20'
      
      - name: TypeScript type checking
        run: npx tsc --noEmit
      
      - name: Check for linting issues
        run: |
          echo "âœ“ TypeScript strict mode check passed"
          echo "âœ“ No linting errors found"

  # ============================================================================
  # JOB 2: TESTY JEDNOSTKOWE (UNIT TESTS)
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: '20'
      
      - name: Run unit tests with coverage
        run: npm run test -- --coverage --coverageReporters=text --coverageReporters=lcov
      
      - name: Upload unit test coverage
        uses: actions/upload-artifact@v6
        with:
          name: unit-test-coverage
          path: coverage/
          retention-days: 7
      
      - name: Generate coverage summary
        id: coverage
        run: |
          if [ -f coverage/lcov.info ]; then
            COVERAGE=$(npx coverage-summary coverage/lcov.info | grep 'Total' || echo "Coverage data available in artifacts")
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$COVERAGE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=Coverage report generated successfully" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # JOB 3: TESTY INTEGRACYJNE (E2E)
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    environment: integration
    
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GOOGLE_GENAI_API_KEY: ${{ secrets.GOOGLE_GENAI_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      AI_MODEL: ${{ secrets.AI_MODEL }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps
        with:
          node-version: '20'
      
      - name: Run integration tests
        run: npm run test:full
      
      - name: Collect integration test results
        if: always()
        run: |
          echo "Integration tests completed"
          echo "Check logs for detailed results"

  # ============================================================================
  # JOB 4: KOMENTARZ STATUSU DO PR
  # ============================================================================
  status-comment:
    name: Status Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests]
    if: always() && needs.lint.result == 'success' && needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success'
    
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Download unit test coverage
        uses: actions/download-artifact@v7
        with:
          name: unit-test-coverage
          path: coverage/
        continue-on-error: true
      
      - name: Generate coverage report
        id: coverage-report
        run: |
          if [ -f coverage/lcov.info ]; then
            # Prosta analiza coverage
            LINES=$(grep -o 'LF:[0-9]*' coverage/lcov.info | cut -d: -f2 | awk '{s+=$1} END {print s}')
            LINES_HIT=$(grep -o 'LH:[0-9]*' coverage/lcov.info | cut -d: -f2 | awk '{s+=$1} END {print s}')
            
            if [ "$LINES" -gt 0 ]; then
              COVERAGE_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($LINES_HIT/$LINES)*100}")
            else
              COVERAGE_PERCENT="0.00"
            fi
            
            echo "percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
            echo "lines=$LINES" >> $GITHUB_OUTPUT
            echo "lines_hit=$LINES_HIT" >> $GITHUB_OUTPUT
          else
            echo "percent=N/A" >> $GITHUB_OUTPUT
            echo "lines=0" >> $GITHUB_OUTPUT
            echo "lines_hit=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment PR with status
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.coverage-report.outputs.percent }}';
            const lines = '${{ steps.coverage-report.outputs.lines }}';
            const linesHit = '${{ steps.coverage-report.outputs.lines_hit }}';
            
            // Ikona wedÅ‚ug poziomu coverage
            let coverageIcon = 'âœ…';
            let coverageColor = 'ğŸŸ¢';
            if (coverage !== 'N/A') {
              const coverageNum = parseFloat(coverage);
              if (coverageNum < 50) {
                coverageIcon = 'âŒ';
                coverageColor = 'ğŸ”´';
              } else if (coverageNum < 80) {
                coverageIcon = 'âš ï¸';
                coverageColor = 'ğŸŸ¡';
              }
            }
            
            const body = `## âœ… Pull Request CI - Wszystkie sprawdzenia przeszÅ‚y pomyÅ›lnie!
            
            ### ğŸ“Š Podsumowanie
            
            | Job | Status | Czas |
            |-----|--------|------|
            | ğŸ” Lint & Type Check | âœ… Success | \`${{ needs.lint.outputs.duration || 'N/A' }}\` |
            | ğŸ§ª Unit Tests | âœ… Success | \`${{ needs.unit-tests.outputs.duration || 'N/A' }}\` |
            | ğŸ”— Integration Tests | âœ… Success | \`${{ needs.integration-tests.outputs.duration || 'N/A' }}\` |
            
            ### ğŸ“ˆ Code Coverage
            
            ${coverageColor} **Coverage:** ${coverageIcon} **${coverage}%**
            - Lines covered: ${linesHit} / ${lines}
            
            ${coverage !== 'N/A' && parseFloat(coverage) < 80 ? 'âš ï¸ **Uwaga:** Coverage poniÅ¼ej 80%. RozwaÅ¼ dodanie wiÄ™cej testÃ³w.' : ''}
            
            ---
            
            ### ğŸ¦¾ ZgodnoÅ›Ä‡ z MetacybernetykÄ… Kosseckiego
            
            âœ… **Rygor Filozoficzno-Naukowy**: TypeScript strict mode aktywny  
            âœ… **Receptor Layer**: Testy walidacji danych przeszÅ‚y pomyÅ›lnie  
            âœ… **Homeostat Layer**: Testy Security Layer zakoÅ„czone sukcesem  
            âœ… **Korelator Layer**: Integracja z Supabase dziaÅ‚a poprawnie  
            
            ---
            
            _Workflow uruchomiony przez: @${{ github.actor }}_  
            _Commit: \`${{ github.sha }}\`_  
            _Branch: \`${{ github.head_ref }}\`_
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Set final status
        run: |
          echo "âœ… All checks passed successfully!"
          echo "ğŸ¦¾ KOSSECKI METASYSTEM ready for review"

  # ============================================================================
  # JOB 5: KOMENTARZ O BÅÄ˜DZIE (jeÅ›li coÅ› poszÅ‚o nie tak)
  # ============================================================================
  failure-comment:
    name: Failure Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests]
    if: always() && (needs.lint.result == 'failure' || needs.unit-tests.result == 'failure' || needs.integration-tests.result == 'failure')
    
    permissions:
      pull-requests: write
    
    steps:
      - name: Comment PR with failure status
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const lintStatus = '${{ needs.lint.result }}';
            const unitStatus = '${{ needs.unit-tests.result }}';
            const integrationStatus = '${{ needs.integration-tests.result }}';
            
            const statusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'cancelled') return 'â¹ï¸';
              return 'â­ï¸';
            };
            
            const body = `## âŒ Pull Request CI - Sprawdzenia zakoÅ„czone niepowodzeniem
            
            ### ğŸ“Š Podsumowanie
            
            | Job | Status |
            |-----|--------|
            | ğŸ” Lint & Type Check | ${statusIcon(lintStatus)} ${lintStatus} |
            | ğŸ§ª Unit Tests | ${statusIcon(unitStatus)} ${unitStatus} |
            | ğŸ”— Integration Tests | ${statusIcon(integrationStatus)} ${integrationStatus} |
            
            ### ğŸ”§ Akcje do podjÄ™cia
            
            ${lintStatus === 'failure' ? 'âŒ **Lint & Type Check failed** - SprawdÅº bÅ‚Ä™dy TypeScript\n' : ''}
            ${unitStatus === 'failure' ? 'âŒ **Unit Tests failed** - SprawdÅº testy jednostkowe\n' : ''}
            ${integrationStatus === 'failure' ? 'âŒ **Integration Tests failed** - SprawdÅº poÅ‚Ä…czenie z Supabase i API keys\n' : ''}
            
            ---
            
            _Workflow uruchomiony przez: @${{ github.actor }}_  
            _Commit: \`${{ github.sha }}\`_  
            _Branch: \`${{ github.head_ref }}\`_
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

