---
/**
 * @fileoverview Dashboard Efektora - Panel Analityczny KMS
 * @cybernetic Efektor - organ wyj≈õciowy systemu
 * 
 * Zgodnie z teoriƒÖ Kosseckiego:
 * - Prezentacja obiekt√≥w i relacji w spos√≥b rzetelny
 * - Ostrze≈ºenia o szumie ideologicznym
 * - Metryki rzetelno≈õci (certainty_score)
 * - Potencja≈Ç sterowniczy (liczba relacji wychodzƒÖcych)
 */

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase/client';
import type { 
  DashboardObject, 
  SystemStats 
} from '../../lib/cybernetics/efektor/types';
import type { 
  CyberneticObject, 
  Correlation 
} from '../../lib/supabase/types';

// ============================================================================
// POBIERANIE DANYCH Z SUPABASE (Server-Side)
// ============================================================================

let objects: DashboardObject[] = [];
let stats: SystemStats = {
  total_objects: 0,
  total_relations: 0,
  average_certainty: 0,
  system_class_distribution: {
    autonomous_system: 0,
    heteronomous_system: 0,
    environment: 0,
    tool: 0,
  },
  control_type_distribution: {
    cognitive: 0,
    ideological: 0,
    ethical: 0,
    economic: 0,
  },
  high_noise_relations: 0,
  ideological_sources: 0,
  contradiction_alerts: 0,
  max_contradiction_severity: 0,
};

try {
  // Pobierz wszystkie obiekty
  const { data: rawObjects, error: objectsError } = await supabase
    .from('cybernetic_objects')
    .select('*')
    .order('created_at', { ascending: false });

  if (objectsError) {
    console.error('[DASHBOARD] B≈ÇƒÖd pobierania obiekt√≥w:', objectsError);
  }

  // Pobierz wszystkie relacje
  const { data: correlations, error: correlationsError } = await supabase
    .from('correlations')
    .select('*');

  if (correlationsError) {
    console.error('[DASHBOARD] B≈ÇƒÖd pobierania relacji:', correlationsError);
  }

  // Oblicz metryki dla ka≈ºdego obiektu
  if (rawObjects && correlations) {
    const objectMetrics = new Map<string, {
      steering_potential: number;
      dependency_count: number;
      total_impact: number;
      total_certainty: number;
      relation_count: number;
    }>();

    rawObjects.forEach(obj => {
      objectMetrics.set(obj.id, {
        steering_potential: 0,
        dependency_count: 0,
        total_impact: 0,
        total_certainty: 0,
        relation_count: 0,
      });
    });

    // Oblicz metryki z relacji
    let totalCertainty = 0;
    let highNoiseCount = 0;
    let ideologicalCount = 0;

    correlations.forEach(rel => {
      const sourceMetrics = objectMetrics.get(rel.source_id);
      const targetMetrics = objectMetrics.get(rel.target_id);

      if (sourceMetrics) {
        sourceMetrics.steering_potential += 1;
        sourceMetrics.total_impact += rel.impact_factor;
        sourceMetrics.total_certainty += rel.certainty_score;
        sourceMetrics.relation_count += 1;
      }

      if (targetMetrics) {
        targetMetrics.dependency_count += 1;
        targetMetrics.total_certainty += rel.certainty_score;
        targetMetrics.relation_count += 1;
      }

      totalCertainty += rel.certainty_score;
      
      if (rel.certainty_score < 0.3) {
        highNoiseCount += 1;
      }
    });

    // Stw√≥rz rozszerzone obiekty
    objects = rawObjects.map(obj => {
      const metrics = objectMetrics.get(obj.id)!;
      const avgCertainty = metrics.relation_count > 0 
        ? metrics.total_certainty / metrics.relation_count 
        : 0;

      // Zlicz typy system√≥w
      stats.system_class_distribution[obj.system_class] += 1;
      stats.control_type_distribution[obj.control_system_type] += 1;

      if (obj.control_system_type === 'ideological') {
        ideologicalCount += 1;
      }

      return {
        ...obj,
        steering_potential: metrics.steering_potential,
        dependency_count: metrics.dependency_count,
        total_impact: metrics.total_impact,
        average_certainty: avgCertainty,
      } as DashboardObject;
    });

    // Oblicz statystyki systemowe
    stats.total_objects = rawObjects.length;
    stats.total_relations = correlations.length;
    stats.average_certainty = correlations.length > 0 
      ? totalCertainty / correlations.length 
      : 0;
    stats.high_noise_relations = highNoiseCount;
    stats.ideological_sources = ideologicalCount;

    // Pobierz alerty sprzeczno≈õci z Homeostatu
    const { data: alerts, error: alertsError } = await supabase
      .from('system_alerts')
      .select('severity')
      .eq('status', 'active')
      .eq('alert_type', 'contradiction');

    if (!alertsError && alerts) {
      stats.contradiction_alerts = alerts.length;
      stats.max_contradiction_severity = alerts.length > 0 
        ? Math.max(...alerts.map(a => a.severity))
        : 0;
    } else {
      stats.contradiction_alerts = 0;
      stats.max_contradiction_severity = 0;
    }
  }
} catch (error) {
  console.error('[DASHBOARD] Krytyczny b≈ÇƒÖd:', error);
}
---

<Layout 
  title="Dashboard - KOSSECKI METASYSTEM"
  description="Panel analityczny systemu rzetelnego researchu"
>
  <main class="min-h-screen p-6 space-y-6">
    <!-- Nag≈Ç√≥wek -->
    <header class="card-terminal p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-terminal-accent uppercase tracking-wider mb-2">
            KOSSECKI METASYSTEM
          </h1>
          <p class="text-terminal-muted">
            Panel Analityczny - Efektor v0.1.0
          </p>
        </div>
        <div class="text-right text-xs text-terminal-muted">
          <div>System rzetelnego researchu</div>
          <div>Oparty na Metacybernetyce J. Kosseckiego</div>
        </div>
      </div>
      
      <!-- Linki do modu≈Ç√≥w -->
      <div class="mt-4 pt-4 border-t border-terminal-border grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <a 
            href="/dashboard/recon" 
            class="inline-flex items-center gap-2 px-4 py-2 bg-control-cognitive text-white font-bold uppercase tracking-wider hover:bg-control-cognitive/80 transition-colors w-full justify-center"
          >
            <span>üîç</span>
            <span>[CENTRUM ZWIADU]</span>
          </a>
          <p class="text-xs text-terminal-muted mt-2">
            Receptor 2.0 - Autonomiczny zwiadu informacyjny
          </p>
        </div>
        
        <div>
          <a 
            href="/dashboard/decisions" 
            class="inline-flex items-center gap-2 px-4 py-2 bg-terminal-accent text-terminal-bg font-bold uppercase tracking-wider hover:bg-terminal-accent/80 transition-colors w-full justify-center"
          >
            <span>üéØ</span>
            <span>[SYMULATOR STEROWANIA]</span>
          </a>
          <p class="text-xs text-terminal-muted mt-2">
            Modu≈Ç Decyzyjny - Analiza wp≈Çywu i rekomendacje
          </p>
        </div>
      </div>
    </header>

    <!-- Ostrze≈ºenie systemowe (je≈õli wykryto ideologiƒô) -->
    {stats.ideological_sources > 0 && (
      <div class="card-terminal p-4 border-2 border-control-ideological bg-control-ideological/10 animate-pulse">
        <div class="flex items-start gap-3">
          <span class="text-2xl">‚ö†</span>
          <div class="flex-1">
            <h3 class="font-bold text-control-ideological mb-1 uppercase tracking-wider">
              Ostrze≈ºenie: Wykryto ≈∫r√≥d≈Ça ideologiczne
            </h3>
            <p class="text-sm text-terminal-text">
              System zidentyfikowa≈Ç {stats.ideological_sources} obiekt(√≥w) z dominujƒÖcym systemem ideologicznym. 
              Zgodnie z rygorem Kosseckiego, takie ≈∫r√≥d≈Ça wymagajƒÖ szczeg√≥lnej weryfikacji rzetelno≈õci.
            </p>
          </div>
        </div>
      </div>
    )}

    <!-- Statystyki systemu -->
    <section>
      <div id="stats-panel" data-stats={JSON.stringify(stats)}></div>
    </section>

    <!-- Formularz Receptor Input -->
    <section>
      <div id="receptor-form"></div>
    </section>

    <!-- Tabela obiekt√≥w -->
    <section>
      <h2 class="text-xl font-bold text-terminal-accent uppercase tracking-wider mb-4">
        [DATABASE] Obiekty Cybernetyczne
      </h2>
      <div id="objects-table" data-objects={JSON.stringify(objects)}></div>
    </section>

    <!-- Graf relacji -->
    <section>
      <div id="relation-graph" class="w-full"></div>
    </section>

    <!-- Footer z metrykami -->
    <footer class="card-terminal p-4 text-center text-xs text-terminal-muted">
      <p>
        ¬© 2024 KOSSECKI METASYSTEM | 
        Receptor ‚Üí Homeostat ‚Üí Korelator ‚Üí Efektor | 
        Powered by Astro 5 + React 19 + Supabase
      </p>
      <p class="mt-2">
        Teoria: doc. J√≥zef Kossecki "Metacybernetyka - Cybernetyka Drugiego Rzƒôdu"
      </p>
    </footer>
  </main>
</Layout>

<script>
  /**
   * @cybernetic Client-side hydration dla komponent√≥w React
   * Astro Server Islands - komponenty renderowane tylko po stronie klienta
   */
  import { createRoot } from 'react-dom/client';
  import { createElement } from 'react';
  import { StatisticsPanel } from '../../components/cybernetics/StatisticsPanel';
  import { ReceptorInputForm } from '../../components/cybernetics/ReceptorInputForm';
  import { ObjectsTable } from '../../components/cybernetics/ObjectsTable';
  import { RelationGraph } from '../../components/cybernetics/RelationGraph';

  // Hydrate Statistics Panel
  const statsPanel = document.getElementById('stats-panel');
  if (statsPanel) {
    const stats = JSON.parse(statsPanel.dataset.stats || '{}');
    const root = createRoot(statsPanel);
    root.render(createElement(StatisticsPanel, { stats }));
  }

  // Hydrate Receptor Form
  const receptorForm = document.getElementById('receptor-form');
  if (receptorForm) {
    const root = createRoot(receptorForm);
    root.render(
      createElement(ReceptorInputForm, {
        onProcessComplete: () => {
          // Od≈õwie≈º stronƒô po przetworzeniu sygna≈Çu
          window.location.reload();
        },
      })
    );
  }

  // Hydrate Objects Table
  const objectsTable = document.getElementById('objects-table');
  if (objectsTable) {
    const objects = JSON.parse(objectsTable.dataset.objects || '[]');
    const root = createRoot(objectsTable);
    root.render(
      createElement(ObjectsTable, {
        objects,
        onObjectClick: (objectId: string) => {
          console.log('[DASHBOARD] Clicked object:', objectId);
          // TODO: Otw√≥rz modal z szczeg√≥≈Çami obiektu
        },
      })
    );
  }

  // Hydrate Relation Graph
  const relationGraph = document.getElementById('relation-graph');
  if (relationGraph) {
    const root = createRoot(relationGraph);
    // Dopasuj szeroko≈õƒá do kontenera
    const width = relationGraph.clientWidth || 1200;
    root.render(
      createElement(RelationGraph, {
        width,
        height: 600,
        className: 'w-full',
      })
    );
  }
</script>

